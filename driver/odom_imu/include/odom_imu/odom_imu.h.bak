#ifndef __ODOM_IMU__
#define __ODOM_IMU__

#include "user_protocol.h"
#include <can_msgs/vehicle_status.h>
#include <geometry_msgs/Point.h>
#include <geometry_msgs/Twist.h>
#include <nav_msgs/Odometry.h>
#include <queue>
#include <ros/duration.h>
#include <ros/ros.h>
#include <sensor_msgs/Imu.h>
#include <std_msgs/Float32.h>
#include <tf/transform_broadcaster.h>
#include <tf/transform_listener.h>

class OdomImu {
public:
    OdomImu(const ros::NodeHandle nh, const ros::NodeHandle pnh)
        : nh_(nh)
        , pnh_(pnh)
    {
    }
    ~OdomImu();
    bool init();

private:
    ros::NodeHandle nh_;
    ros::NodeHandle pnh_;

    tf::TransformBroadcaster tf_broadcaster_;
    tf::TransformListener tf_listener_;
    tf::StampedTransform tf_btoi_;
    bool tf_init_;

    ros::Publisher pub_odom_, pub_odom_imu_;
    nav_msgs::Odometry msg_odom_;

    ros::Subscriber sub_imu_;
    sensor_msgs::Imu msg_imu_;
    // ros::Subscriber sub_encoder_;
    ros::Subscriber sub_odom_;
    geometry_msgs::TwistStamped msg_encoder_;
    geometry_msgs::TwistStamped cur_vel_;

    ros::Time pre_time_;
    bool first_imu_;
    bool first_encoder_;

    pose pre_pose_;
    pose current_pose_;
    double current_vel_x_;
    double current_vel_y_;
    double current_vel_z_;

    double param_max_interval_;
    double param_angle_vel_sensitive_;
    double param_linear_vel_sensitive_;
    std::string param_base_frame_;
    std::string param_odom_frame_;
    std::string sub_imu_topic_;
    std::string sub_hall_topic_;

    void imuCB(const sensor_msgs::Imu::ConstPtr& msg);
    // void encoderCB(const geometry_msgs::TwistStampedConstPtr &msg);
    // void odomCB(const can_msgs::feedback::ConstPtr& msg);
    void odomCB(const can_msgs::vehicle_status::ConstPtr& msg);
};

class IMU {
public:
    IMU(const ros::NodeHandle nh, const ros::NodeHandle pnh)
        : nh_(nh)
        , pnh_(pnh)
    {
    }
    ~IMU();
    bool init();

private:
    ros::NodeHandle nh_;
    ros::NodeHandle pnh_;

    tf::TransformBroadcaster tf_broadcaster_;
    tf::TransformListener tf_listener_;
    tf::StampedTransform tf_btoi_;
    bool tf_init_;

    ros::Publisher pub_odom_imu_;
    ros::Subscriber sub_pose_, sub_imu_;
    sensor_msgs::Imu msg_imu_;
    nav_msgs::Odometry msg_odom_;

    std::queue<geometry_msgs::PoseStamped> q;
    // geometry_msgs::TwistStamped cur_vel_;
    geometry_msgs::PoseStamped predict_current_pose_;
    ros::Publisher pub_predict_pose_;

    ros::Time pre_time_;
    bool first_imu_;
    bool first_pose_;

    pose pre_pose_;
    pose current_pose_;
    double current_vel_x_;
    double current_vel_y_;
    double current_vel_z_;

    double param_max_interval_;
    double param_angle_vel_sensitive_;
    double param_linear_vel_sensitive_;
    std::string param_base_frame_;
    std::string param_odom_frame_;
    std::string sub_imu_topic_;

    ros::Publisher pub_debug_vel_;

    void imuCB(const sensor_msgs::Imu::ConstPtr& msg);

    void poseCB(const geometry_msgs::PoseStampedConstPtr& msg);
};

#endif